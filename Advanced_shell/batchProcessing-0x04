#!/bin/bash

POKEMON_LIST="bulbasaur ivysaur charmander charmeleon"
PIDS=()
TIMEOUT=10

fetch_pokemon() {
    local pokemon=$1
    echo "Fetching$pokemon ..."
    curl -s "https://pokeapi.co/api/v2/pokemon/$pokemon" -o "${pokemon}.json"
}

for p in "${POKEMONS[@]}"; do
    fetch_pokemon "$p" &
    PIDS+=($!)
done

echo "Running jobs..."
jobs

SECS=0
while [[ ${#PIDS[@]} -gt 0 ]]; do
    sleep 1
    SECS=$(( SECS + 1))

    for i in "${!PIDS[@]}"; do
        if ! kill -0 "${PIDS[$i]}" 2>/dev/null; then
            unset 'PIDS[$i]'
        fi
    done

    if [[ $SECS -ge $TIMEOUT ]]; then
        echo "Timeout reached. Killing remaining jobs..."
        for pid in "${PIDS[@]}"; do
            kill "$pid" 2>/dev/null
        done
        break
    fi
done

wait
echo "All tasks completed."